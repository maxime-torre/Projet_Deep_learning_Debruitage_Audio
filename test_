import os
import numpy as np
import matplotlib.pyplot as plt
from pydub import AudioSegment
from librosa import load, resample

def calculer_snr(audio_data):
    # Calculer la puissance du signal (moyenne des valeurs au carré)
    signal_power = np.mean(audio_data ** 2)
    
    # Calculer la puissance du bruit (variance des valeurs)
    noise_power = np.var(audio_data)
    
    if noise_power > 0:
        return 10 * np.log10(signal_power / noise_power)
    else:
        return np.inf  # Retourner l'infini si la puissance du bruit est 0

def tracer_snr_dossiers(audio_folder, max_files):
    if not os.path.exists(audio_folder):
        print(f"Le chemin spécifié n'existe pas : {audio_folder}")
        return

    noms_fichiers = []
    valeurs_snr = []

    compteur = 0

    # Parcourir les fichiers dans le dossier spécifié
    for current_path, subfolders, files in os.walk(audio_folder):
        for file in files:
            if file.endswith('.flac') and compteur <= max_files:
                try:
                    full_audio_path = os.path.join(audio_folder, file)
                    print(f"full_audio_path : {full_audio_path}")
                    y, sr = load(full_audio_path, sr=None)

                    # Calculer le SNR
                    snr = calculer_snr(y)

                    # Ajouter les informations dans les listes
                    noms_fichiers.append(file)
                    valeurs_snr.append(snr)

                    compteur += 1
                except Exception as e:
                    print(f"Impossible de traiter le fichier {file}: {str(e)}")

    # Tracer le graphique si nous avons des données
    if noms_fichiers:
        plt.figure(figsize=(15, 7))
        plt.bar(noms_fichiers, valeurs_snr, color='blue')
        plt.xlabel('Nom du fichier')
        plt.ylabel('Rapport Signal/Bruit (dB)')
        plt.xticks(rotation=45, ha='right')
        plt.title('Rapport Signal/Bruit pour chaque fichier audio')
        plt.tight_layout()
        plt.show()
    else:
        print("Aucune donnée à tracer.")

# Utilisation de la fonction
path = r"C:\Users\torre\Documents\Sicom 3A\Projet_Parole_Audio_SICOM_3A\noised_data" # spécifiez le chemin vers votre dossier contenant les fichiers audio
max_files = 150  # spécifiez le nombre maximal de fichiers à traiter
tracer_snr_dossiers(path, max_files)
